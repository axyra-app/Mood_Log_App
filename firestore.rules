rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // REGLAS PARA USUARIOS (SIMPLIFICADAS)
    // ========================================
    match /users/{userId} {
      // Solo el usuario puede leer/escribir su propio perfil
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Cualquier usuario autenticado puede leer usuarios con role: 'psychologist'
      allow read: if request.auth != null && 
        resource.data.role == 'psychologist';
    }
    
    // ========================================
    // REGLAS PARA PERFILES DE PSICÓLOGOS
    // ========================================
    match /psychologists/{psychologistId} {
      // Cualquier usuario autenticado puede leer psicólogos disponibles
      allow read: if request.auth != null;
      
      // Solo el psicólogo puede escribir su propio perfil
      allow write: if request.auth != null && request.auth.uid == psychologistId;
      
      // Permitir creación de psicólogos por defecto (con userId específico)
      allow create: if request.auth != null && 
        (request.resource.data.userId.matches('default-psychologist-.*') ||
         request.auth.uid == request.resource.data.userId);
      
      // Permitir eliminación de psicólogos corruptos o por defecto
      allow delete: if request.auth != null && 
        (resource.data.userId.matches('default-psychologist-.*') ||
         request.auth.uid == psychologistId);
      
      // Los pacientes pueden leer datos básicos de su psicólogo asignado
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/patients/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/patients/$(request.auth.uid)).data.psychologistId == psychologistId;
    }
    
    // ========================================
    // REGLAS PARA REGISTROS DE ESTADO DE ÁNIMO
    // ========================================
    match /moodLogs/{logId} {
      // Solo el usuario puede leer/escribir sus propios registros
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // Permitir crear nuevos registros
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      
      // Los psicólogos pueden leer registros de sus pacientes
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/patients/$(resource.data.userId)) &&
        get(/databases/$(database)/documents/patients/$(resource.data.userId)).data.psychologistId == request.auth.uid;
    }
    
    // ========================================
    // REGLAS PARA CITAS
    // ========================================
    match /appointments/{appointmentId} {
      // El usuario puede leer/escribir sus propias citas
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // El psicólogo puede leer/escribir citas de sus pacientes
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.psychologistId;
      
      // Permitir crear nuevas citas
      allow create: if request.auth != null && 
        (request.auth.uid == request.resource.data.userId ||
         request.auth.uid == request.resource.data.psychologistId);
    }
    
    // ========================================
    // REGLAS PARA NOTIFICACIONES
    // ========================================
    match /notifications/{notificationId} {
      // El usuario puede leer/escribir sus propias notificaciones
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // Permitir crear nuevas notificaciones
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // ========================================
    // REGLAS PARA SESIONES DE CHAT
    // ========================================
    match /chatSessions/{sessionId} {
      // El usuario puede leer/escribir sus propias sesiones de chat
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // El psicólogo puede leer/escribir sesiones de chat de sus pacientes
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.psychologistId;
      
      // Permitir crear nuevas sesiones de chat
      allow create: if request.auth != null && 
        (request.auth.uid == request.resource.data.userId ||
         request.auth.uid == request.resource.data.psychologistId);
    }
    
    // ========================================
    // REGLAS PARA CHATS
    // ========================================
    match /chats/{chatId} {
      // El usuario puede leer/escribir chats donde participa
      allow read, write: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      // Permitir crear nuevos chats donde el usuario participa
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.participants;
    }
    
    // ========================================
    // REGLAS PARA MENSAJES
    // ========================================
    match /messages/{messageId} {
      // El usuario puede leer/escribir mensajes donde participa
      allow read, write: if request.auth != null && 
        (request.auth.uid == resource.data.senderId || 
         request.auth.uid == resource.data.receiverId);
      
      // Permitir crear nuevos mensajes
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.senderId;
    }
    
    // ========================================
    // REGLAS PARA DIARIO
    // ========================================
    match /journalEntries/{entryId} {
      // El usuario puede leer/escribir sus propias entradas del diario
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // Permitir crear nuevas entradas del diario
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    match /journalTemplates/{templateId} {
      // Todos los usuarios autenticados pueden leer plantillas del diario
      allow read: if request.auth != null;
      
      // Solo el sistema puede crear plantillas por defecto
      allow create: if request.auth != null && 
        request.resource.data.createdBy == 'system';
    }
    
    match /journalPrompts/{promptId} {
      // Todos los usuarios autenticados pueden leer prompts del diario
      allow read: if request.auth != null;
      
      // Solo el sistema puede crear prompts por defecto
      allow create: if request.auth != null && 
        request.resource.data.createdBy == 'system';
    }
    
    // ========================================
    // REGLAS PARA PACIENTES
    // ========================================
    match /patients/{patientId} {
      // El paciente puede leer/escribir su propio perfil
      allow read, write: if request.auth != null && 
        request.auth.uid == patientId;
      
      // El psicólogo asignado puede leer/escribir el perfil del paciente
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.psychologistId;
      
      // Permitir crear nuevos perfiles de pacientes
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // ========================================
    // REGLAS PARA INFORMES MÉDICOS
    // ========================================
    match /medicalReports/{reportId} {
      // Solo el psicólogo puede leer/escribir informes médicos
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.psychologistId;
      
      // El paciente puede leer sus propios informes médicos
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.patientId;
      
      // Permitir crear nuevos informes médicos
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.psychologistId;
    }
    
    // ========================================
    // REGLAS PARA HISTORIAL DE PACIENTES
    // ========================================
    match /patientHistory/{historyId} {
      // Solo el psicólogo puede leer/escribir historial de pacientes
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.psychologistId;
      
      // El paciente puede leer su propio historial
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.patientId;
      
      // Permitir crear nuevo historial de pacientes
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.psychologistId;
    }
    
    // ========================================
    // REGLAS PARA RECORDATORIOS
    // ========================================
    match /reminders/{reminderId} {
      // Solo el usuario puede leer/escribir sus propios recordatorios
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // Permitir crear nuevos recordatorios
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // ========================================
    // REGLAS PARA PLANES DE TRATAMIENTO
    // ========================================
    match /treatmentPlans/{planId} {
      // Solo el psicólogo puede gestionar planes de tratamiento
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.psychologistId;
      
      // El paciente puede leer su plan de tratamiento
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.patientId;
    }
    
    // ========================================
    // REGLAS PARA ALERTAS DE CRISIS
    // ========================================
    match /crisisAlerts/{alertId} {
      // Solo el psicólogo asignado puede leer/escribir alertas
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.psychologistId;
      
      // El paciente puede leer sus propias alertas
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.patientId;
    }
    
    // ========================================
    // REGLAS PARA RECOMENDACIONES
    // ========================================
    match /recommendations/{recommendationId} {
      // El usuario puede leer/escribir sus recomendaciones
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // Los psicólogos pueden crear recomendaciones para sus pacientes
      allow create: if request.auth != null && 
        (request.auth.uid == request.resource.data.userId ||
         (exists(/databases/$(database)/documents/patients/$(request.resource.data.userId)) &&
          get(/databases/$(database)/documents/patients/$(request.resource.data.userId)).data.psychologistId == request.auth.uid));
    }
    
    // ========================================
    // REGLAS PARA OBJETIVOS DE BIENESTAR
    // ========================================
    match /wellnessGoals/{goalId} {
      // El usuario puede leer/escribir sus objetivos
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // Los psicólogos pueden leer objetivos de sus pacientes
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/patients/$(resource.data.userId)) &&
        get(/databases/$(database)/documents/patients/$(resource.data.userId)).data.psychologistId == request.auth.uid;
    }
    
    // ========================================
    // REGLAS PARA AUDIT LOGS
    // ========================================
    match /auditLogs/{logId} {
      // Solo el usuario puede leer sus propios logs de auditoría
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // Solo el sistema puede escribir logs de auditoría
      allow write: if false; // Los logs se escriben desde el backend
    }
  }
}